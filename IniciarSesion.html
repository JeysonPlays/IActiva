<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IActiva - Acceso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(135deg, #8b0000 0%, #4b0082 100%);
      }
      .card {
        background-color: #fff;
        border-radius: 1.5rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
    </style>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        onSnapshot,
        doc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // ** CONFIGURACIÓN DE FIREBASE **
      const firebaseConfig = {
        apiKey: "AIzaSyC7Oy5KlVEvFCcpnsCraXvrItWS6rfFiCc",
        authDomain: "iactiva1.firebaseapp.com",
        projectId: "iactiva1",
        storageBucket: "iactiva1.firebasestorage.app",
        messagingSenderId: "533961740268",
        appId: "1:533961740268:web:9df1be242c7f547d087ac9",
        measurementId: "G-9ZQLEL5ESC",
      };

      const appId = "iactiva1";

      // Inicializa Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // Elementos de la UI
      const usernameInput = document.getElementById("username");
      const passwordInput = document.getElementById("password");
      const loginButton = document.getElementById("login-button");
      const errorMessage = document.getElementById("error-message");
      const loadingMessage = document.getElementById("loading-message");

      let USERS = {};

      async function authenticate() {
        try {
          await signInAnonymously(auth);
        } catch (error) {
          console.error("Error al iniciar sesión anónimamente:", error);
          loadingMessage.textContent = "Error de conexión.";
        }
      }

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          loadingMessage.textContent = "Conectando a la base de datos...";
          const usersCollection = collection(
            db,
            `/artifacts/${appId}/public/data/users`
          );
          onSnapshot(usersCollection, (snapshot) => {
            loadingMessage.textContent = "Cargando usuarios...";
            USERS = {};
            snapshot.forEach((doc) => {
              const data = doc.data();
              USERS[data.username] = { ...data, id: doc.id };
            });
            loginButton.disabled = false;
            loadingMessage.classList.add("hidden");
          });
        } else {
          loginButton.disabled = true;
          loadingMessage.classList.remove("hidden");
          loadingMessage.textContent = "Autenticando...";
          authenticate();
        }
      });

      loginButton.addEventListener("click", async () => {
        const username = usernameInput.value.toLowerCase();
        const password = passwordInput.value;
        const user = USERS[username];

        if (user && user.password === password) {
          try {
            const userRef = doc(
              db,
              `/artifacts/${appId}/public/data/users`,
              user.id
            );
            await updateDoc(userRef, {
              auth_uid: auth.currentUser.uid,
            });
            sessionStorage.setItem("username", username);
            window.location.href = "admin.html";
          } catch (e) {
            console.error("Error al actualizar el usuario:", e);
            errorMessage.textContent =
              "Error al iniciar sesión. Inténtalo de nuevo.";
            errorMessage.classList.remove("hidden");
          }
        } else {
          errorMessage.textContent = "Usuario o contraseña incorrectos.";
          errorMessage.classList.remove("hidden");
        }
      });
    </script>
  </head>
  <body class="bg-gray-100 p-0 m-0 overflow-x-hidden font-sans text-gray-800">
    <div class="min-h-screen flex items-center justify-center p-4">
      <div class="card w-full max-w-md p-8 space-y-6">
        <h1 class="text-3xl font-bold text-center text-red-700">IActiva</h1>
        <h2 class="text-xl font-semibold text-center text-gray-600">
          Iniciar Sesión
        </h2>
        <div class="space-y-4">
          <div>
            <label for="username" class="block text-gray-700">Usuario:</label>
            <input
              type="text"
              id="username"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-300 focus:ring focus:ring-red-200 focus:ring-opacity-50 px-3 py-2"
            />
          </div>
          <div>
            <label for="password" class="block text-gray-700"
              >Contraseña:</label
            >
            <input
              type="password"
              id="password"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-300 focus:ring focus:ring-red-200 focus:ring-opacity-50 px-3 py-2"
            />
          </div>
          <button
            id="login-button"
            class="w-full bg-red-600 text-white py-2 rounded-full hover:bg-red-700 transition-colors"
            disabled
          >
            Entrar
          </button>
          <p id="loading-message" class="text-center text-gray-500 mt-2">
            Cargando...
          </p>
          <p id="error-message" class="text-red-500 text-center hidden mt-2">
            Mensaje de error
          </p>
        </div>
      </div>
    </div>
  </body>
</html>
