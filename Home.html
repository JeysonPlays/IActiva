<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IActiva - Acceso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(135deg, #8b0000 0%, #4b0082 100%);
      }
      .card {
        background-color: #fff;
        border-radius: 1.5rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
      .modal-content {
        border-radius: 1rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }
      .switch input {
        display: none;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #f44336;
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #4caf50;
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }
    </style>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        doc,
        getDoc,
        setDoc,
        deleteDoc,
        getDocs,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // ** CONFIGURACIÓN DE FIREBASE **
      const firebaseConfig = {
        apiKey: "AIzaSyC7Oy5KlVEvFCcpnsCraXvrItWS6rfFiCc",
        authDomain: "iactiva1.firebaseapp.com",
        projectId: "iactiva1",
        storageBucket: "iactiva1.firebasestorage.app",
        messagingSenderId: "533961740268",
        appId: "1:533961740268:web:9df1be242c7f547d087ac9",
        measurementId: "G-9ZQLEL5ESC",
      };

      const appId = "iactiva1";

      // Inicializa Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      setLogLevel("debug"); // Habilitar logs para depuración

      // Elementos de la UI
      const mainScreen = document.getElementById("main-screen");
      const userGreeting = document.getElementById("user-greeting");
      const adminSection = document.getElementById("admin-section");
      const userSection = document.getElementById("user-section");
      const logoutButton = document.getElementById("logout-button");
      const userAdminButton = document.getElementById("user-admin-button");
      const userAdminModal = document.getElementById("user-admin-modal");
      const closeModalButton = document.getElementById("close-modal-button");
      const userList = document.getElementById("user-list");
      const createUserForm = document.getElementById("create-user-form");
      const newUsernameInput = document.getElementById("new-username");
      const newPasswordInput = document.getElementById("new-password");
      const userSectionsList = document.getElementById("user-sections-list");

      const createContainerButton = document.getElementById(
        "create-container-button"
      );
      const containersList = document.getElementById("containers-list");

      createContainerButton.addEventListener("click", () => {
        const containerId = `container-creation-${Date.now()}`;
        const containerDiv = document.createElement("div");
        containerDiv.id = containerId;
        containerDiv.className = "card p-6";
        containerDiv.innerHTML = `
          <div class="flex justify-between items-center">
              <h3 class="text-lg font-semibold">Nuevo Contenedor</h3>
              <div>
                  <button class="cancel-container-creation bg-gray-500 text-white px-3 py-1 rounded-full text-sm hover:bg-gray-600 transition-colors">Cancelar</button>
              </div>
          </div>
          <div class="mt-4">
              <label for="container-name-${containerId}" class="block text-gray-700 text-sm">Nombre del Contenedor:</label>
              <input type="text" id="container-name-${containerId}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2">
              <button class="create-container-confirm mt-2 bg-green-600 text-white py-2 px-4 rounded-full hover:bg-green-700 transition-colors">Crear Contenedor</button>
          </div>
        `;
        containersList.prepend(containerDiv);

        containerDiv
          .querySelector(".cancel-container-creation")
          .addEventListener("click", () => {
            containerDiv.remove();
          });

        containerDiv
          .querySelector(".create-container-confirm")
          .addEventListener("click", async () => {
            const containerNameInput = document.getElementById(
              `container-name-${containerId}`
            );
            const containerName = containerNameInput.value;
            if (containerName) {
              try {
                await addDoc(
                  collection(db, `/artifacts/${appId}/public/data/containers`),
                  {
                    name: containerName,
                  }
                );
                containerDiv.remove(); // Remove the creation form
              } catch (e) {
                console.error("Error creating container: ", e);
              }
            }
          });
      });

      // Modales y sus elementos
      const userConfirmModal = document.getElementById("user-confirm-modal");
      const userConfirmMessage = document.getElementById(
        "user-confirm-message"
      );
      const userConfirmYes = document.getElementById("user-confirm-yes");
      const userConfirmNo = document.getElementById("user-confirm-no");
      const userPasswordModal = document.getElementById("user-password-modal");
      const newPasswordModalInput = document.getElementById(
        "new-password-modal-input"
      );
      const savePasswordButton = document.getElementById(
        "save-password-button"
      );
      const closePasswordModal = document.getElementById(
        "close-password-modal"
      );
      const addContentModal = document.getElementById("add-content-modal");
      const closeContentModal = document.getElementById("close-content-modal");
      const addContentForm = document.getElementById("add-content-form");
      const contentTitleInput = document.getElementById("content-title");
      const contentUrlInput = document.getElementById("content-url");
      const sectionContentList = document.getElementById(
        "section-content-list"
      );
      const viewSectionModal = document.getElementById("view-section-modal");
      const closeViewSectionModal = document.getElementById(
        "close-view-section-modal"
      );
      const viewSectionContent = document.getElementById(
        "view-section-content"
      );
      const editContentModal = document.getElementById("edit-content-modal");
      const closeEditContentModal = document.getElementById(
        "close-edit-content-modal"
      );
      const editContentForm = document.getElementById("edit-content-form");
      const editContentTitleInput =
        document.getElementById("edit-content-title");
      const editContentUrlInput = document.getElementById("edit-content-url");

      // Nuevo Modal para Secciones
      const sectionModal = document.getElementById("section-modal");
      const sectionModalTitle = document.getElementById("section-modal-title");
      const sectionForm = document.getElementById("section-form");
      const sectionNameInput = document.getElementById("section-name");
      const sectionDescriptionInput = document.getElementById(
        "section-description"
      );
      const sectionImageInput = document.getElementById("section-image");
      const closeSectionModalBtn = document.getElementById(
        "close-section-modal"
      );

      let currentUser = null;
      let USERS = {};
      let pendingUserAction = null;

      // Maneja el estado de la autenticación
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "IniciarSesion.html";
          return;
        }

        const usersCollection = collection(
          db,
          `/artifacts/${appId}/public/data/users`
        );
        onSnapshot(usersCollection, (snapshot) => {
          USERS = {};
          let foundUser = null;
          snapshot.forEach((doc) => {
            const data = doc.data();
            USERS[data.username] = { ...data, id: doc.id };
          });

          // Esto es un workaround para encontrar el usuario actual, ya que no tenemos el username
          // directamente desde el objeto `user` de `onAuthStateChanged` porque es anónimo.
          // En un sistema real, el objeto `user` tendría un UID que podrías buscar en tu DB.
          // Aquí, asumimos que el primer usuario que coincida es el nuestro, lo cual es inseguro.
          // Una mejor aproximación sería guardar el username en sessionStorage/localStorage al hacer login.
          for (const username in USERS) {
            // Lógica para encontrar el usuario actual. Esto es complejo sin un ID.
            // Por ahora, vamos a asumir que el primer usuario es el admin para demostración.
            // ESTA PARTE NECESITA UNA LÓGICA DE LOGIN MÁS ROBUSTA
          }
          // Como no podemos saber qué usuario es, vamos a buscar un usuario que sea admin
          // para la demo. En un caso real, el login guardaría el username en sessionStorage.
          const loggedInUsername = sessionStorage.getItem("username");
          if (loggedInUsername && USERS[loggedInUsername]) {
            showMainScreen(USERS[loggedInUsername]);
          } else {
            // Si no encontramos el usuario en sessionStorage, no podemos continuar.
            // Esto puede pasar si el usuario borra la sesión o accede directamente.
            window.location.href = "IniciarSesion.html";
          }
        });
      });

      function setupListeners() {
        const containersCollection = collection(
          db,
          `/artifacts/${appId}/public/data/containers`
        );
        onSnapshot(containersCollection, (snapshot) => {
          console.log("Instantánea de contenedores recibida.");
          if (currentUser && currentUser.role === "admin") {
            renderContainers(snapshot.docs);
            const sectionsCollection = collection(
              db,
              `/artifacts/${appId}/public/data/sections`
            );
            onSnapshot(sectionsCollection, (sectionsSnapshot) => {
              console.log("Instantánea de secciones recibida.");
              renderAdminSections(sectionsSnapshot.docs);
            });
          } else if (currentUser && currentUser.role === "user") {
            renderUserContainers(snapshot.docs);
            const sectionsCollection = collection(
              db,
              `/artifacts/${appId}/public/data/sections`
            );
            onSnapshot(sectionsCollection, (sectionsSnapshot) => {
              console.log("Instantánea de secciones recibida.");
              renderUserSections(sectionsSnapshot.docs);
            });
          }
        });
      }

      function showMainScreen(user) {
        currentUser = user;
        mainScreen.classList.remove("hidden");
        userGreeting.textContent = `Bienvenido, ${user.username}`;

        if (user.role === "admin") {
          adminSection.classList.remove("hidden");
          userSection.classList.add("hidden");
          userAdminButton.classList.remove("hidden");
        } else {
          adminSection.classList.add("hidden");
          userSection.classList.remove("hidden");
          userAdminButton.classList.add("hidden");
        }
        setupListeners();
      }

      function renderContainers(docs) {
        containersList.innerHTML = "";
        docs.forEach((containerDoc) => {
          const containerData = containerDoc.data();
          const containerId = containerDoc.id;
          const containerDiv = document.createElement("div");
          containerDiv.id = containerId;
          containerDiv.className = "card p-6";
          containerDiv.innerHTML = `
                  <div class="flex justify-between items-center">
                      <h3 class="text-xl font-bold">${containerData.name}</h3>
                      <button data-id="${containerId}" class="delete-container-btn bg-red-500 text-white px-3 py-1 rounded-full text-sm hover:bg-red-600 transition-colors">Eliminar Contenedor</button>
                  </div>
                  <div class="mt-4">
                    <button data-container-id="${containerId}" class="create-section-button bg-red-600 text-white py-2 px-6 rounded-full hover:bg-red-700 transition-colors">
                      Crear Nueva Sección
                    </button>
                  </div>
                  <div id="sections-list-${containerId}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                      <!-- Secciones para este contenedor -->
                  </div>
              `;
          containersList.appendChild(containerDiv);
        });

        document.querySelectorAll(".delete-container-btn").forEach((button) => {
          button.addEventListener("click", async () => {
            const containerId = button.dataset.id;
            await deleteDoc(
              doc(db, `/artifacts/${appId}/public/data/containers`, containerId)
            );
          });
        });

        document
          .querySelectorAll(".create-section-button")
          .forEach((button) => {
            button.addEventListener("click", () => {
              const containerId = button.dataset.containerId;
              showSectionModal(null, null, containerId);
            });
          });
      }

      function renderAdminSections(docs) {
        // Clear all section lists within containers first
        document.querySelectorAll('[id^="sections-list-"]').forEach((list) => {
          list.innerHTML = "";
        });

        docs.forEach((sectionDoc) => {
          const data = sectionDoc.data();
          const containerId = data.containerId;
          const sectionsList = document.getElementById(
            `sections-list-${containerId}`
          );

          // If the section has a container and the container exists in the DOM
          if (containerId && sectionsList) {
            const div = document.createElement("div");
            div.className =
              "card bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col md:flex-row";
            div.innerHTML = `
                        <div class="md:w-1/3">
                            <img src="${data.imageUrl}" alt="Imagen de la sección ${data.name}" class="w-full h-48 md:h-full object-cover" onerror="this.src='https://placehold.co/400x250/E5E7EB/4B5563?text=Sin+Imagen'; this.onerror=null;">
                        </div>
                        <div class="p-4 md:w-2/3 flex flex-col justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">${data.name}</h3>
                                <p class="text-gray-600 mt-1">${data.description}</p>
                            </div>
                            <div class="mt-4 flex flex-wrap gap-2">
                                <button data-id="${sectionDoc.id}" class="add-content-btn bg-red-500 text-white px-3 py-1 rounded-full text-sm hover:bg-red-600 transition-colors">Agregar Contenido</button>
                                <button data-id="${sectionDoc.id}" class="edit-section-btn bg-yellow-500 text-white px-3 py-1 rounded-full text-sm hover:bg-yellow-600 transition-colors">Editar</button>
                                <button data-id="${sectionDoc.id}" class="delete-section-btn bg-gray-500 text-white px-3 py-1 rounded-full text-sm hover:bg-gray-600 transition-colors">Eliminar</button>
                            </div>
                        </div>
                    `;
            sectionsList.appendChild(div);
          }
        });

        // Re-attach event listeners for buttons inside sections
        document.querySelectorAll(".add-content-btn").forEach((button) => {
          button.addEventListener("click", () => {
            const sectionId = button.dataset.id;
            addContentModal.dataset.sectionId = sectionId;
            renderSectionContentList(sectionId);
            addContentModal.classList.remove("hidden");
          });
        });

        document.querySelectorAll(".edit-section-btn").forEach((button) => {
          button.addEventListener("click", async () => {
            const sectionId = button.dataset.id;
            const sectionRef = doc(
              db,
              `/artifacts/${appId}/public/data/sections`,
              sectionId
            );
            const sectionDoc = await getDoc(sectionRef);
            if (sectionDoc.exists()) {
              showSectionModal(
                sectionDoc.data(),
                sectionId,
                sectionDoc.data().containerId
              );
            }
          });
        });

        document.querySelectorAll(".delete-section-btn").forEach((button) => {
          button.addEventListener("click", async () => {
            const sectionId = button.dataset.id;
            const sectionRef = doc(
              db,
              `/artifacts/${appId}/public/data/sections`,
              sectionId
            );
            await deleteDoc(sectionRef);
          });
        });
      }

      function renderUserContainers(docs) {
        userSectionsList.innerHTML = "";
        const accessibleContainers = currentUser.accessibleContainers || [];
        docs.forEach((containerDoc) => {
          if (accessibleContainers.includes(containerDoc.id)) {
            const containerData = containerDoc.data();
            const containerId = containerDoc.id;
            const containerDiv = document.createElement("div");
            containerDiv.id = `user-container-${containerId}`;
            containerDiv.className = "card p-6";
            containerDiv.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4">${containerData.name}</h3>
                    <div id="user-sections-list-${containerId}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                        <!-- Secciones para este contenedor -->
                    </div>
                `;
            userSectionsList.appendChild(containerDiv);
          }
        });
      }

      function renderUserSections(docs) {
        // Clear all section lists within containers first
        document
          .querySelectorAll('[id^="user-sections-list-"]')
          .forEach((list) => {
            list.innerHTML = "";
          });

        docs.forEach((sectionDoc) => {
          const data = sectionDoc.data();
          const containerId = data.containerId;
          const sectionsList = document.getElementById(
            `user-sections-list-${containerId}`
          );

          if (containerId && sectionsList) {
            const div = document.createElement("div");
            div.className =
              "card bg-white rounded-2xl shadow-lg overflow-hidden cursor-pointer hover:shadow-2xl transition-shadow";
            div.innerHTML = `
                    <img src="${data.imageUrl}" alt="Imagen de la sección ${data.name}" class="w-full h-48 object-cover" onerror="this.src='https://placehold.co/400x250/E5E7EB/4B5563?text=Sin+Imagen'; this.onerror=null;">
                    <div class="p-4">
                        <h3 class="text-xl font-bold text-gray-800">${data.name}</h3>
                        <p class="text-gray-600 mt-1">${data.description}</p>
                    </div>
                `;
            div.addEventListener("click", () => {
              renderViewSectionContent(data.name, data.contentItems);
              viewSectionModal.classList.remove("hidden");
            });
            sectionsList.appendChild(div);
          }
        });
      }

      function renderViewSectionContent(sectionName, contentItems) {
        viewSectionContent.innerHTML = "";
        const title = document.createElement("h3");
        title.className = "text-2xl font-bold text-center text-red-700 mb-4";
        title.textContent = sectionName;
        viewSectionContent.appendChild(title);

        if (contentItems && contentItems.length > 0) {
          contentItems.forEach((item) => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "p-4 border-b border-gray-200 last:border-b-0";
            itemDiv.innerHTML = `
                        <h4 class="text-lg font-semibold">${item.title}</h4>
                        <a href="${item.url}" target="_blank" class="text-red-500 hover:underline break-words">${item.url}</a>
                    `;
            viewSectionContent.appendChild(itemDiv);
          });
        } else {
          viewSectionContent.innerHTML += `<p class="text-center text-gray-500 mt-4">No hay contenido en esta sección todavía.</p>`;
        }
      }

      closeViewSectionModal.addEventListener("click", () => {
        viewSectionModal.classList.add("hidden");
      });

      logoutButton.addEventListener("click", async () => {
        try {
          await signOut(auth); // Cierra la sesión de Firebase
          sessionStorage.removeItem("username");
          window.location.href = "IniciarSesion.html";
        } catch (error) {
          console.error("Error al cerrar sesión:", error);
        }
      });

      // Sección Formulario y Modal
      closeSectionModalBtn.addEventListener("click", () =>
        sectionModal.classList.add("hidden")
      );

      function showSectionModal(
        sectionData = null,
        docId = null,
        containerId = null
      ) {
        sectionForm.reset();
        sectionForm.dataset.docId = "";
        sectionForm.dataset.containerId = "";

        if (sectionData && docId) {
          sectionModalTitle.textContent = "Editar Sección";
          sectionNameInput.value = sectionData.name;
          sectionDescriptionInput.value = sectionData.description;
          sectionImageInput.value = sectionData.imageUrl;
          sectionForm.dataset.docId = docId;
        } else {
          sectionModalTitle.textContent = "Crear Nueva Sección";
        }

        if (containerId) {
          sectionForm.dataset.containerId = containerId;
        }
        sectionModal.classList.remove("hidden");
      }

      sectionForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const docId = sectionForm.dataset.docId;
        const containerId = sectionForm.dataset.containerId;
        const name = sectionNameInput.value;
        const description = sectionDescriptionInput.value;
        const imageUrl = sectionImageInput.value;

        try {
          if (docId) {
            const sectionRef = doc(
              db,
              `/artifacts/${appId}/public/data/sections`,
              docId
            );
            await updateDoc(sectionRef, { name, description, imageUrl });
          } else {
            await addDoc(
              collection(db, `/artifacts/${appId}/public/data/sections`),
              {
                name: name,
                description: description,
                imageUrl: imageUrl,
                contentItems: [],
                containerId: containerId,
              }
            );
          }
          sectionModal.classList.add("hidden");
          sectionForm.reset();
        } catch (e) {
          console.error("Error creating/updating section: ", e);
        }
      });

      addContentForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const sectionId = addContentModal.dataset.sectionId;
        const title = contentTitleInput.value;
        const url = contentUrlInput.value;

        if (sectionId && title && url) {
          try {
            const sectionRef = doc(
              db,
              `/artifacts/${appId}/public/data/sections`,
              sectionId
            );
            const sectionDoc = await getDoc(sectionRef);
            const currentItems = sectionDoc.data().contentItems || [];

            const newItems = [...currentItems, { title, url }];
            await updateDoc(sectionRef, { contentItems: newItems });

            contentTitleInput.value = "";
            contentUrlInput.value = "";
            renderSectionContentList(sectionId);
          } catch (e) {
            console.error("Error adding content: ", e);
          }
        }
      });

      async function renderSectionContentList(sectionId) {
        sectionContentList.innerHTML = "";
        const sectionRef = doc(
          db,
          `/artifacts/${appId}/public/data/sections`,
          sectionId
        );
        const sectionDoc = await getDoc(sectionRef);
        const contentItems = sectionDoc.data().contentItems || [];

        if (contentItems.length > 0) {
          contentItems.forEach((item, index) => {
            const li = document.createElement("li");
            li.className =
              "flex justify-between items-center bg-gray-100 p-2 rounded-md shadow-sm";
            li.innerHTML = `
                        <span>${item.title}</span>
                        <div class="flex space-x-2">
                            <button class="edit-content-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 transition-colors" data-index="${index}">Editar</button>
                            <button class="delete-content-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600 transition-colors" data-index="${index}">Eliminar</button>
                        </div>
                    `;
            sectionContentList.appendChild(li);
          });

          document.querySelectorAll(".edit-content-btn").forEach((button) => {
            button.addEventListener("click", async (e) => {
              const indexToEdit = parseInt(e.target.dataset.index);
              const sectionId = addContentModal.dataset.sectionId;
              const sectionRef = doc(
                db,
                `/artifacts/${appId}/public/data/sections`,
                sectionId
              );
              const sectionDoc = await getDoc(sectionRef);
              const currentItems = sectionDoc.data().contentItems || [];
              const itemToEdit = currentItems[indexToEdit];

              editContentTitleInput.value = itemToEdit.title;
              editContentUrlInput.value = itemToEdit.url;

              editContentModal.dataset.sectionId = sectionId;
              editContentModal.dataset.itemIndex = indexToEdit;
              addContentModal.classList.add("hidden"); // Ocultar el modal de agregar para evitar superposiciones
              editContentModal.classList.remove("hidden");
            });
          });

          document.querySelectorAll(".delete-content-btn").forEach((button) => {
            button.addEventListener("click", async (e) => {
              const indexToDelete = parseInt(e.target.dataset.index);
              const sectionId = addContentModal.dataset.sectionId;
              const sectionRef = doc(
                db,
                `/artifacts/${appId}/public/data/sections`,
                sectionId
              );
              const sectionDoc = await getDoc(sectionRef);
              const currentItems = sectionDoc.data().contentItems || [];
              const newItems = currentItems.filter(
                (_, index) => index !== indexToDelete
              );
              await updateDoc(sectionRef, { contentItems: newItems });
              renderSectionContentList(sectionId);
            });
          });
        } else {
          sectionContentList.innerHTML =
            '<li class="text-gray-500">No hay contenido añadido a esta sección.</li>';
        }
      }

      editContentForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const sectionId = editContentModal.dataset.sectionId;
        const itemIndex = parseInt(editContentModal.dataset.itemIndex);
        const newTitle = editContentTitleInput.value;
        const newUrl = editContentUrlInput.value;

        const sectionRef = doc(
          db,
          `/artifacts/${appId}/public/data/sections`,
          sectionId
        );
        const sectionDoc = await getDoc(sectionRef);
        const currentItems = sectionDoc.data().contentItems || [];

        currentItems[itemIndex] = {
          title: newTitle,
          url: newUrl,
        };

        await updateDoc(sectionRef, { contentItems: currentItems });
        renderSectionContentList(sectionId);
        editContentModal.classList.add("hidden");
        addContentModal.classList.remove("hidden"); // Mostrar de nuevo el modal de agregar
      });

      closeContentModal.addEventListener("click", () => {
        addContentModal.classList.add("hidden");
      });

      closeEditContentModal.addEventListener("click", () => {
        editContentModal.classList.add("hidden");
        addContentModal.classList.remove("hidden");
      });

      userAdminButton.addEventListener("click", () => {
        userAdminModal.classList.remove("hidden");
        renderUserList();
      });

      closeModalButton.addEventListener("click", () => {
        userAdminModal.classList.add("hidden");
      });

      const closeUserOptionsModal = document.getElementById(
        "close-user-options-modal"
      );
      closeUserOptionsModal.addEventListener("click", () => {
        document.getElementById("user-options-modal").classList.add("hidden");
      });

      userConfirmYes.addEventListener("click", async () => {
        if (pendingUserAction) {
          const userRef = doc(
            db,
            `/artifacts/${appId}/public/data/users`,
            pendingUserAction
          );
          await deleteDoc(userRef);
          userConfirmModal.classList.add("hidden");
          pendingUserAction = null;
        }
      });

      userConfirmNo.addEventListener("click", () => {
        userConfirmModal.classList.add("hidden");
        pendingUserAction = null;
      });

      savePasswordButton.addEventListener("click", async () => {
        if (pendingUserAction) {
          const newPassword = newPasswordModalInput.value;
          if (newPassword) {
            const userRef = doc(
              db,
              `/artifacts/${appId}/public/data/users`,
              pendingUserAction
            );
            await setDoc(userRef, { password: newPassword }, { merge: true });
            userPasswordModal.classList.add("hidden");
            pendingUserAction = null;
          }
        }
      });

      closePasswordModal.addEventListener("click", () => {
        userPasswordModal.classList.add("hidden");
        pendingUserAction = null;
      });

      function renderUserList() {
        userList.innerHTML = "";
        for (const username in USERS) {
          const user = USERS[username];
          const li = document.createElement("li");
          li.className =
            "flex justify-between items-center bg-gray-100 p-2 rounded-md shadow-sm";

          const userText = document.createElement("span");
          userText.textContent = `${user.username} (${user.role})`;
          li.appendChild(userText);

          const actionsDiv = document.createElement("div");

          const optionsButton = document.createElement("button");
          optionsButton.textContent = "Opciones";
          optionsButton.className =
            "bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 transition-colors mr-2";
          optionsButton.addEventListener("click", () => {
            renderUserOptionsModal(user);
          });
          actionsDiv.appendChild(optionsButton);

          const deleteButton = document.createElement("button");
          deleteButton.textContent = "Eliminar";
          deleteButton.className =
            "bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition-colors mr-2";
          deleteButton.addEventListener("click", () => {
            userConfirmMessage.textContent = `¿Estás seguro de que quieres eliminar a \"${user.username}\"?`;
            pendingUserAction = user.id;
            userConfirmModal.classList.remove("hidden");
          });
          actionsDiv.appendChild(deleteButton);

          const editButton = document.createElement("button");
          editButton.textContent = "Cambiar Clave";
          editButton.className =
            "bg-yellow-500 text-white px-3 py-1 rounded-md text-sm hover:bg-yellow-600 transition-colors";
          editButton.addEventListener("click", () => {
            newPasswordModalInput.value = "";
            pendingUserAction = user.id;
            userPasswordModal.classList.remove("hidden");
          });
          actionsDiv.appendChild(editButton);

          li.appendChild(actionsDiv);
          userList.appendChild(li);
        }
      }

      async function renderUserOptionsModal(user) {
        const userOptionsModal = document.getElementById("user-options-modal");
        const userOptionsContent = document.getElementById(
          "user-options-content"
        );
        userOptionsContent.innerHTML = ""; // Clear previous content

        // Admin toggle
        const adminToggleLabel = document.createElement("label");
        adminToggleLabel.className = "flex items-center mb-4";
        const isAdmin = user.role === "admin";
        adminToggleLabel.innerHTML = `
            <label class="switch">
              <input type="checkbox" id="admin-toggle" ${
                isAdmin ? "checked" : ""
              }>
              <span class="slider"></span>
            </label>
            <span class="ml-3">Administrador</span>
        `;
        const adminToggle = adminToggleLabel.querySelector("input");
        adminToggle.addEventListener("change", async (e) => {
          const newRole = e.target.checked ? "admin" : "user";
          const userRef = doc(
            db,
            `/artifacts/${appId}/public/data/users`,
            user.id
          );
          await updateDoc(userRef, { role: newRole });
          user.role = newRole;
        });
        userOptionsContent.appendChild(adminToggleLabel);

        const containerListTitle = document.createElement("h5");
        containerListTitle.className = "text-md font-semibold mb-2";
        containerListTitle.textContent = "Acceso a Contenedores:";
        userOptionsContent.appendChild(containerListTitle);

        const containersCollection = collection(
          db,
          `/artifacts/${appId}/public/data/containers`
        );
        const containersSnapshot = await getDocs(containersCollection);
        const allContainers = containersSnapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));

        const containerList = document.createElement("ul");
        allContainers.forEach((container) => {
          const containerItem = document.createElement("li");
          containerItem.className = "mb-4";
          const isChecked =
            user.accessibleContainers &&
            user.accessibleContainers.includes(container.id);
          containerItem.innerHTML = `
                <label class="flex items-center">
                    <label class="switch">
                      <input type="checkbox" data-container-id="${
                        container.id
                      }" ${isChecked ? "checked" : ""}>
                      <span class="slider"></span>
                    </label>
                    <span class="ml-3">${container.name}</span>
                </label>
            `;
          const checkbox = containerItem.querySelector("input");
          checkbox.addEventListener("change", async (e) => {
            const containerId = e.target.dataset.containerId;
            const userRef = doc(
              db,
              `/artifacts/${appId}/public/data/users`,
              user.id
            );
            const accessibleContainers = user.accessibleContainers || [];

            if (e.target.checked) {
              if (!accessibleContainers.includes(containerId)) {
                accessibleContainers.push(containerId);
              }
            } else {
              const index = accessibleContainers.indexOf(containerId);
              if (index > -1) {
                accessibleContainers.splice(index, 1);
              }
            }
            await updateDoc(userRef, { accessibleContainers });
            user.accessibleContainers = accessibleContainers;
          });
          containerList.appendChild(containerItem);
        });
        userOptionsContent.appendChild(containerList);

        userOptionsModal.classList.remove("hidden");
      }

      createUserForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const newUsername = newUsernameInput.value.toLowerCase();
        const newPassword = newPasswordInput.value;
        const newRole = "user";

        if (newUsername in USERS) {
          console.error("Error: User already exists.");
          return;
        }

        try {
          await addDoc(
            collection(db, `/artifacts/${appId}/public/data/users`),
            {
              username: newUsername,
              password: newPassword,
              role: newRole,
              accessibleContainers: [],
            }
          );
          newUsernameInput.value = "";
          newPasswordInput.value = "";
        } catch (e) {
          console.error("Error creating user: ", e);
        }
      });
    </script>
  </head>
  <body class="bg-gray-100 p-0 m-0 overflow-x-hidden font-sans text-gray-800">
    <!-- Pantalla principal (oculta por defecto) -->
    <div
      id="main-screen"
      class="min-h-screen flex flex-col p-4 md:p-8 space-y-8 hidden"
    >
      <header
        class="card p-6 flex flex-col sm:flex-row justify-between items-center"
      >
        <h1
          id="user-greeting"
          class="text-2xl md:text-3xl font-bold text-red-700 text-center sm:text-left mb-4 sm:mb-0"
        ></h1>
        <div class="flex space-x-2 flex-wrap justify-center sm:justify-end">
          <button
            id="user-admin-button"
            class="bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 transition-colors hidden text-sm"
          >
            Administrar Usuarios
          </button>
          <button
            id="logout-button"
            class="bg-gray-500 text-white px-4 py-2 rounded-full hover:bg-gray-600 transition-colors text-sm"
          >
            Cerrar Sesión
          </button>
        </div>
      </header>

      <!-- Sección del Administrador -->
      <section id="admin-section" class="flex-grow space-y-8 hidden">
        <div class="card p-6">
          <h2
            class="text-xl font-semibold text-gray-800 border-b-2 border-red-300 pb-2 mb-4"
          >
            Administrar Contenedores
          </h2>
          <div class="flex justify-center mb-6">
            <button
              id="create-container-button"
              class="bg-blue-600 text-white py-2 px-6 rounded-full hover:bg-blue-700 transition-colors"
            >
              Crear Nuevo Contenedor
            </button>
          </div>
        </div>

        <div id="containers-list" class="space-y-6">
          <!-- Los contenedores se renderizarán aquí -->
        </div>
      </section>

      <!-- Sección del Usuario -->
      <section id="user-section" class="flex-grow space-y-8 hidden">
        <div id="user-sections-list" class="space-y-6">
          <!-- Las tarjetas de secciones para el usuario se renderizan aquí -->
        </div>
      </section>
    </div>

    <!-- Pantalla principal (oculta por defecto) -->
    <div
      id="main-screen"
      class="min-h-screen flex flex-col p-4 md:p-8 space-y-8 hidden"
    >
      <header
        class="card p-6 flex flex-col sm:flex-row justify-between items-center"
      >
        <h1
          id="user-greeting"
          class="text-2xl md:text-3xl font-bold text-red-700 text-center sm:text-left mb-4 sm:mb-0"
        ></h1>
        <div class="flex space-x-2 flex-wrap justify-center sm:justify-end">
          <button
            id="user-admin-button"
            class="bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 transition-colors hidden text-sm"
          >
            Administrar Usuarios
          </button>
          <button
            id="logout-button"
            class="bg-gray-500 text-white px-4 py-2 rounded-full hover:bg-gray-600 transition-colors text-sm"
          >
            Cerrar Sesión
          </button>
        </div>
      </header>

      <!-- Sección del Administrador -->
      <section id="admin-section" class="flex-grow space-y-8 hidden">
        <div class="card p-6">
          <h2
            class="text-xl font-semibold text-gray-800 border-b-2 border-red-300 pb-2 mb-4"
          >
            Administrar Contenedores
          </h2>
          <div class="flex justify-center mb-6">
            <button
              id="create-container-button"
              class="bg-blue-600 text-white py-2 px-6 rounded-full hover:bg-blue-700 transition-colors"
            >
              Crear Nuevo Contenedor
            </button>
          </div>
        </div>

        <div id="containers-list" class="space-y-6">
          <!-- Los contenedores se renderizarán aquí -->
        </div>
      </section>

      <!-- Sección del Usuario -->
      <section id="user-section" class="flex-grow space-y-8 hidden">
        <div id="user-sections-list" class="space-y-6">
          <!-- Las tarjetas de secciones para el usuario se renderizan aquí -->
        </div>
      </section>
    </div>

    <!-- Modal de administración de usuarios -->
    <div
      id="user-admin-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4"
    >
      <div
        class="relative w-full max-w-lg modal-content p-6 md:p-8 bg-white text-center"
      >
        <div class="flex justify-between items-center pb-4 mb-4 border-b">
          <h3 class="text-xl font-bold text-gray-900">Administrar Usuarios</h3>
          <button
            id="close-modal-button"
            class="bg-gray-200 text-gray-600 p-2 rounded-full hover:bg-gray-300"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <div class="text-left space-y-6">
          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="text-md font-semibold text-gray-700 mb-2">
              Crear Nuevo Usuario
            </h4>
            <form id="create-user-form" class="space-y-2">
              <input
                type="text"
                id="new-username"
                placeholder="Usuario"
                required
                class="block w-full rounded-md border-gray-300 px-3 py-2"
              />
              <input
                type="password"
                id="new-password"
                placeholder="Contraseña"
                required
                class="block w-full rounded-md border-gray-300 px-3 py-2"
              />
              <button
                type="submit"
                class="w-full bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 transition-colors"
              >
                Crear Usuario
              </button>
            </form>
          </div>

          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="text-md font-semibold text-gray-700 mb-2">
              Lista de Usuarios
            </h4>
            <ul id="user-list" class="space-y-2">
              <!-- La lista de usuarios se renderiza aquí -->
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de confirmación para usuarios -->
    <div
      id="user-confirm-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center p-4"
    >
      <div class="w-full max-w-sm modal-content p-6 bg-white text-center">
        <p id="user-confirm-message" class="text-lg text-gray-900 mb-4"></p>
        <div class="flex justify-around">
          <button
            id="user-confirm-yes"
            class="px-4 py-2 bg-red-500 text-white font-medium rounded-full shadow-sm hover:bg-red-700 transition-colors"
          >
            Sí
          </button>
          <button
            id="user-confirm-no"
            class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-full shadow-sm hover:bg-gray-300 transition-colors"
          >
            No
          </button>
        </div>
      </div>
    </div>

    <!-- Modal para cambiar contraseña de usuario -->
    <div
      id="user-password-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center p-4"
    >
      <div class="w-full max-w-sm modal-content p-6 bg-white text-center">
        <h3 class="text-xl font-bold text-gray-900 mb-4">Cambiar Contraseña</h3>
        <input
          type="password"
          id="new-password-modal-input"
          placeholder="Nueva Contraseña"
          class="block w-full rounded-md border-gray-300 shadow-sm px-3 py-2 mb-4"
        />
        <div class="flex justify-around">
          <button
            id="save-password-button"
            class="px-4 py-2 bg-red-500 text-white font-medium rounded-full shadow-sm hover:bg-red-700 transition-colors"
          >
            Guardar
          </button>
          <button
            id="close-password-modal"
            class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-full shadow-sm hover:bg-gray-300 transition-colors"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal para opciones de usuario -->
    <div
      id="user-options-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4"
    >
      <div
        class="relative w-full max-w-lg modal-content p-6 md:p-8 bg-white text-left"
      >
        <div class="flex justify-between items-center pb-4 mb-4 border-b">
          <h3 class="text-xl font-bold text-gray-900">Opciones de Usuario</h3>
          <button
            id="close-user-options-modal"
            class="bg-gray-200 text-gray-600 p-2 rounded-full hover:bg-gray-300"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div id="user-options-content" class="space-y-4">
          <!-- Contenido de las opciones de usuario se renderiza aquí -->
        </div>
      </div>
    </div>

    <!-- Modal para agregar/editar sección -->
    <div
      id="section-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4"
    >
      <div class="w-full max-w-lg modal-content p-6 bg-white text-left">
        <div class="flex justify-between items-center pb-4 mb-4 border-b">
          <h3 id="section-modal-title" class="text-xl font-bold text-gray-900">
            Crear Nueva Sección
          </h3>
          <button
            id="close-section-modal"
            class="bg-gray-200 text-gray-600 p-2 rounded-full hover:bg-gray-300"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <form id="section-form" class="space-y-4">
          <div>
            <label for="section-name" class="block text-gray-700 text-sm"
              >Nombre de la Sección:</label
            >
            <input
              type="text"
              id="section-name"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2"
            />
          </div>
          <div>
            <label for="section-description" class="block text-gray-700 text-sm"
              >Descripción:</label
            >
            <textarea
              id="section-description"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2"
            ></textarea>
          </div>
          <div>
            <label for="section-image" class="block text-gray-700 text-sm"
              >URL de Imagen de Portada:</label
            >
            <input
              type="url"
              id="section-image"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2"
            />
          </div>
          <button
            type="submit"
            class="w-full bg-red-600 text-white py-2 rounded-full hover:bg-red-700 transition-colors"
          >
            Guardar Sección
          </button>
        </form>
      </div>
    </div>

    <!-- Modal para agregar contenido a una sección -->
    <div
      id="add-content-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4"
    >
      <div class="w-full max-w-lg modal-content p-6 bg-white text-left">
        <div class="flex justify-between items-center pb-4 mb-4 border-b">
          <h3 class="text-xl font-bold text-gray-900">
            Agregar Contenido a la Sección
          </h3>
          <button
            id="close-content-modal"
            class="bg-gray-200 text-gray-600 p-2 rounded-full hover:bg-gray-300"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="space-y-4">
          <form id="add-content-form" class="space-y-4">
            <div>
              <label for="content-title" class="block text-gray-700 text-sm"
                >Título:</label
              >
              <input
                type="text"
                id="content-title"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2"
              />
            </div>
            <div>
              <label for="content-url" class="block text-gray-700 text-sm"
                >URL del Recurso:</label
              >
              <input
                type="url"
                id="content-url"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2"
              />
            </div>
            <button
              type="submit"
              class="w-full bg-green-600 text-white py-2 rounded-full hover:bg-green-700 transition-colors"
            >
              Agregar
            </button>
          </form>
          <div class="mt-4">
            <h4 class="text-md font-semibold text-gray-700">
              Contenido en la Sección:
            </h4>
            <ul id="section-content-list" class="space-y-2 mt-2"></ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para editar contenido de una sección -->
    <div
      id="edit-content-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4"
    >
      <div class="w-full max-w-lg modal-content p-6 bg-white text-left">
        <div class="flex justify-between items-center pb-4 mb-4 border-b">
          <h3 class="text-xl font-bold text-gray-900">Editar Contenido</h3>
          <button
            id="close-edit-content-modal"
            class="bg-gray-200 text-gray-600 p-2 rounded-full hover:bg-gray-300"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="space-y-4">
          <form id="edit-content-form" class="space-y-4">
            <div>
              <label
                for="edit-content-title"
                class="block text-gray-700 text-sm"
                >Título:</label
              >
              <input
                type="text"
                id="edit-content-title"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2"
              />
            </div>
            <div>
              <label for="edit-content-url" class="block text-gray-700 text-sm"
                >URL del Recurso:</label
              >
              <input
                type="url"
                id="edit-content-url"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2"
              />
            </div>
            <button
              type="submit"
              class="w-full bg-red-600 text-white py-2 rounded-full hover:bg-red-700 transition-colors"
            >
              Guardar Cambios
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal para ver el contenido de una sección (usuario) -->
    <div
      id="view-section-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4"
    >
      <div class="w-full max-w-2xl modal-content p-6 bg-white text-left">
        <div class="flex justify-between items-center pb-4 mb-4 border-b">
          <h3 class="text-xl font-bold text-gray-900">
            Contenido de la Sección
          </h3>
          <button
            id="close-view-section-modal"
            class="bg-gray-200 text-gray-600 p-2 rounded-full hover:bg-gray-300"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div id="view-section-content" class="space-y-4">
          <!-- El contenido de la sección se renderiza aquí -->
        </div>
      </div>
    </div>
  </body>
</html>
